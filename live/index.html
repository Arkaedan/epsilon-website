<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.metroui.org.ua/v4/css/metro-all.min.css">
    <link rel="stylesheet" href="custom.css">
    
	<script>
    var programPanelButtons = [{
        html: "<span class='mif-help'></span>",
        cls: "sys-button",
        onclick: "window.open('https://www.eclipse.org/epsilon/doc/eol');"
    },{
        html: "<span class='mif-play'></span>",
        cls: "success",
        onclick: "eol()"
    }];
    var modelPanelButtons = [{
        html: "<span class='mif-help'></span>",
        cls: "sys-button",
        onclick: "window.open('https://www.eclipse.org/epsilon/doc/flexmi');"
    }];
    var metamodelPanelButtons = [{
        html: "<span class='mif-help'></span>",
        cls: "sys-button",
        onclick: "window.open('https://www.eclipse.org/emfatic');"
    }];
    var consolePanelButtons = [{
        html: "<span class='mif-cross'></span>",
        cls: "sys-button",
        onclick: "consoleEditor.setValue('')"
    }];
    </script>
</head>

<body class="h-100" onresize="fit()">
    <div data-role="navview">
        <div class="navview-pane">
            <button class="pull-button">
                <span class="default-icon-menu"></span>
            </button>
            <ul class="navview-menu">
                <li class="item-header">Epsilon Playground</li>
                <li>
                    <a href="#" id="exampleLink">
                        <span class="icon"><span class="mif-apps"></span></span>
                        <span class="caption">Link to this example</span>
                    </a>
                </li>
                
            </ul>
        </div>
        <div class="navview-content">
            <div id="splitter" data-role="splitter" class="h-100" data-min-sizes="100" style="min-height:800px">
                <div data-role="splitter" data-split-mode="vertical">
                    <div id="EOL" data-role="panel" data-title-caption="Program (EOL)" data-title-icon="<span class='mif-apps'></span>" data-custom-buttons="programPanelButtons">
                        <div class="editor" id="eolEditor"></div>
                    </div>
                    <div data-role="panel" data-title-caption="Console" data-title-icon="<span class='mif-display'></span>" data-custom-buttons="consolePanelButtons">
                        <div class="editor" id="console"></div>
                    </div>
                </div>
                <div data-role="splitter" data-split-mode="vertical">
                    <div data-role="panel" data-title-caption="Model (Flexmi)" data-title-icon="<span class='mif-tree'></span>" data-custom-buttons="modelPanelButtons">
                        <div class="editor" id="flexmiEditor"></div>
                    </div>
                    <div data-role="panel" data-title-caption="Metamodel (Emfatic)" data-title-icon="<span class='mif-cloud3'></span>" data-custom-buttons="metamodelPanelButtons">
                        <div class="editor" id="emfaticEditor"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.metroui.org.ua/v4/js/metro.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="eol.js" type="text/javascript"></script>
    <script src="emfatic.js" type="text/javascript"></script>
    <script>
    Array.from(document.querySelectorAll('.editor')).forEach(function(e) {
        var editor = ace.edit(e);
        editor.setTheme("ace/theme/eclipse");
        editor.renderer.setShowGutter(false);
        editor.setFontSize("1rem");
    });

    var eolEditor = ace.edit(document.getElementById('eolEditor'));
    var flexmiEditor = ace.edit(document.getElementById('flexmiEditor'));
    var emfaticEditor = ace.edit(document.getElementById('emfaticEditor'));
    var consoleEditor = ace.edit(document.getElementById('console'));

    eolEditor.setShowPrintMargin(false);
    flexmiEditor.setShowPrintMargin(false);
    emfaticEditor.setShowPrintMargin(false);
    consoleEditor.setShowPrintMargin(false);

    eolEditor.getSession().setMode("ace/mode/eol");

    console.log(eolEditor.getSession().getMode());

    emfaticEditor.getSession().setMode("ace/mode/emfatic");
    flexmiEditor.getSession().setMode("ace/mode/xml");
    consoleEditor.setReadOnly(true);

    eolEditor.getSession().on('change', function() {
        updateExampleLink();
    });
    flexmiEditor.getSession().on('change', function() {
        updateExampleLink();
    });
    emfaticEditor.getSession().on('change', function() {
        updateExampleLink();
    });

    var url = window.location + "";
    var questionMark = url.indexOf("?");
    var content = "eyJlb2wiOiIvLyBGb3IgZXZlcnkgdGFzayBpbiB0aGUgbW9kZWxcbmZvciAodCBpbiBUYXNrLmFsbCkge1xuICAgIC8vIFByaW50IHRoZSB0aXRsZSBhbmQgdGhlIHRvdGFsIHBlcnNvbi1tb250aHMgb2YgdGhlIHRhc2tcbiAgICAodC50aXRsZSArIFwiOiBcIiArIHQuZ2V0VG90YWxFZmZvcnQoKSkucHJpbnRsbigpO1xufVxuXG4vLyBDb3VudCB0aGUgdGFza3MgdGhhdCBhcmUgdW5kZXJ0YWtlbiBieSBhIHNpbmdsZSBwZXJzb25cblRhc2suYWxsLnNlbGVjdCh0fHQuZWZmb3J0LnNpemUoKSA9IDEpLnNpemUoKS5cbiAgICBwcmludGxuKFwiT25lLXBlcnNvbiB0YXNrczogXCIpO1xuXG4vLyBSZXR1cm5zIHRoZSB0b3RhbCBwZXJzb24tbW9udGhzIGZvciBhIHRhc2tcbm9wZXJhdGlvbiBUYXNrIGdldFRvdGFsRWZmb3J0KCkge1xuICAgIHJldHVybiBzZWxmLmVmZm9ydC5jb2xsZWN0KGV8c2VsZi5kdXJhdGlvbiplLnBlcmNlbnRhZ2UvMTAwLjApLnN1bSgpO1xufSIsImVtZmF0aWMiOiJAbmFtZXNwYWNlKHVyaT1cInBzbFwiLCBwcmVmaXg9XCJcIilcbnBhY2thZ2UgcHNsO1xuXG5jbGFzcyBQcm9qZWN0IHtcbiAgYXR0ciBTdHJpbmcgbmFtZTtcbiAgYXR0ciBTdHJpbmcgZGVzY3JpcHRpb247XG4gIHZhbCBUYXNrWypdIHRhc2tzO1xuICB2YWwgUGVyc29uWypdIHBlb3BsZTtcbn1cblxuY2xhc3MgVGFzayB7XG4gIGF0dHIgU3RyaW5nIHRpdGxlO1xuICBhdHRyIGludCBzdGFydDtcbiAgYXR0ciBpbnQgZHVyYXRpb247XG4gIHZhbCBFZmZvcnRbKl0gZWZmb3J0O1xufVxuXG5jbGFzcyBQZXJzb24ge1xuICBhdHRyIFN0cmluZyBuYW1lO1xufVxuXG5jbGFzcyBFZmZvcnQge1xuICByZWYgUGVyc29uIHBlcnNvbjtcbiAgYXR0ciBpbnQgcGVyY2VudGFnZSA9IDEwMDtcbn0iLCJmbGV4bWkiOiI8P25zdXJpIHBzbD8+XG48cHJvamVjdCB0aXRsZT1cIkFDTUVcIj5cbiAgPHBlcnNvbiBuYW1lPVwiQWxpY2VcIi8+XG4gIDxwZXJzb24gbmFtZT1cIkJvYlwiLz5cbiAgPHRhc2sgdGl0bGU9XCJBbmFseXNpc1wiIHN0YXJ0PVwiMVwiIGR1cj1cIjNcIj5cbiAgICA8ZWZmb3J0IHBlcnNvbj1cIkFsaWNlXCIvPlxuICA8L3Rhc2s+XG4gIDx0YXNrIHRpdGxlPVwiRGVzaWduXCIgc3RhcnQ9XCI0XCIgZHVyPVwiNlwiPlxuICAgIDxlZmZvcnQgcGVyc29uPVwiQm9iXCIvPlxuICA8L3Rhc2s+XG4gIDx0YXNrIHRpdGxlPVwiSW1wbGVtZW50YXRpb25cIiBzdGFydD1cIjdcIiBkdXI9XCIzXCI+XG4gICAgPGVmZm9ydCBwZXJzb249XCJCb2JcIiBwZXJjPVwiNTBcIi8+XG4gICAgPGVmZm9ydCBwZXJzb249XCJBbGljZVwiIHBlcmM9XCI1MFwiLz5cbiAgPC90YXNrPlxuPC9wcm9qZWN0PlxuIn0=";

    if (questionMark > -1) {
        content = url.substring(questionMark+1, url.length);
    }

    var json = JSON.parse(atob(content));
    eolEditor.setValue(json.eol, 1);
    flexmiEditor.setValue(json.flexmi, 1);
    emfaticEditor.setValue(json.emfatic, 1);
    consoleEditor.setValue("",1);
    
    setInterval(fit, 100);

    function updateExampleLink() {
        document.getElementById('exampleLink').href = "?" + btoa(editorsToJson());
    }

    function editorsToJson() {
        return JSON.stringify({"eol": eolEditor.getValue(), "emfatic": emfaticEditor.getValue(), "flexmi": flexmiEditor.getValue()});
    }

    function fit() {
        document.getElementById("splitter").style.minHeight = window.innerHeight + "px";

        var editorParentStyle = "flex-basis: calc(100% - 4px);";

        document.getElementById("eolEditor").parentNode.style = editorParentStyle;
        document.getElementById("flexmiEditor").parentNode.style = editorParentStyle;
        document.getElementById("emfaticEditor").parentNode.style = editorParentStyle;
        document.getElementById("console").parentNode.style = editorParentStyle;
        
        eolEditor.resize();
        flexmiEditor.resize();
        emfaticEditor.resize();
        consoleEditor.resize();
    }

	function eol() {
		
        var xhr = new XMLHttpRequest();
        var url = "https://europe-west2-epsilon-live-gcp.cloudfunctions.net/run-eol";
        //var url = "http://localhost:8080";
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var json = JSON.parse(xhr.responseText);
                consoleEditor.setValue(json.output, 1);
            }
        };
        var data = editorsToJson();
        xhr.send(data);

	}

    </script>
</body>

</html>